{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentos.dev/schemas/skill.schema.json",
  "title": "AgentOS Skill",
  "description": "Schema for AgentOS skill readme.md frontmatter",
  "type": "object",
  "required": ["id", "name", "description"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier (lowercase, hyphenated)",
      "pattern": "^[a-z][a-z0-9-]*$"
    },
    "name": {
      "type": "string",
      "description": "Display name"
    },
    "description": {
      "type": "string",
      "description": "One-line description of what this skill does"
    },
    "icon": {
      "type": "string",
      "description": "Icon filename (icon.svg or icon.png)",
      "default": "icon.png"
    },
    "website": {
      "type": "string",
      "format": "uri",
      "description": "URL to the service's website"
    },
    "color": {
      "type": "string",
      "description": "Brand color as hex (e.g., '#FF4500')",
      "pattern": "^#[0-9A-Fa-f]{6}$"
    },
    "privacy_url": {
      "type": "string",
      "format": "uri",
      "description": "URL to the service's privacy policy"
    },
    "terms_url": {
      "type": "string",
      "format": "uri",
      "description": "URL to the service's terms of service"
    },
    "auth": {
      "oneOf": [
        { "const": "none", "description": "No authentication required" },
        { "$ref": "#/definitions/auth" }
      ]
    },
    "api": {
      "$ref": "#/definitions/api"
    },
    "database": {
      "oneOf": [
        { "type": "string", "description": "Path to SQLite database (supports ~ and globs)" },
        {
          "type": "object",
          "description": "Platform-specific database paths",
          "properties": {
            "macos": { "type": "string" },
            "windows": { "type": "string" },
            "linux": { "type": "string" }
          }
        }
      ]
    },
    "transformers": {
      "type": "object",
      "description": "Entity transformers that transform API data into universal entity format. Each key is an entity type.",
      "additionalProperties": {
        "$ref": "#/definitions/transformer"
      }
    },
    "operations": {
      "type": "object",
      "description": "Entity operations (e.g., task.list, message.send). Naming: {entity}.{operation}",
      "propertyNames": {
        "pattern": "^[a-z_]+\\.[a-z_]+$"
      },
      "additionalProperties": {
        "$ref": "#/definitions/operation"
      }
    },
    "utilities": {
      "type": "object",
      "description": "Helper operations that return custom shapes (not entities). Naming: verb_noun",
      "propertyNames": {
        "pattern": "^[a-z_]+$"
      },
      "additionalProperties": {
        "$ref": "#/definitions/utility"
      }
    },
    "instructions": {
      "type": "string",
      "description": "Free-form instructions for AI about how to use this skill"
    },
    "requires": {
      "type": "array",
      "description": "System dependencies that must be installed",
      "items": {
        "$ref": "#/definitions/dependency"
      }
    },
    "handles": {
      "type": "object",
      "description": "URL patterns this adapter handles for routing",
      "properties": {
        "urls": {
          "type": "array",
          "description": "URL patterns (e.g., 'youtube.com/*', 'github.com/*/issues/*')",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "sources": {
      "$ref": "#/definitions/skillSources"
    },
    "connects_to": {
      "oneOf": [
        {
          "type": "string",
          "description": "Single product seed entity ID this adapter connects to"
        },
        {
          "type": "array",
          "items": { "type": "string" },
          "description": "Product seed entity IDs this adapter connects to"
        }
      ],
      "description": "Product(s) this skill connects to — references seed entity IDs (e.g., 'youtube', 'whatsapp')"
    },
    "seed": {
      "type": "array",
      "description": "Seed entities to create on startup (products, organizations this skill connects to)",
      "items": {
        "$ref": "#/definitions/seedEntity"
      }
    },
    "platforms": {
      "type": "array",
      "description": "Platforms this skill has been tested on",
      "items": {
        "type": "string",
        "enum": ["macos", "windows", "linux"]
      }
    },
    "testing": {
      "type": "object",
      "description": "Test configuration — exemptions for test linting requirements",
      "properties": {
        "exempt": {
          "type": "object",
          "description": "Test exemptions — keys are check names, values are reasons",
          "additionalProperties": {
            "type": "string",
            "description": "Reason for exemption"
          }
        }
      },
      "additionalProperties": false
    },
    "agent": {
      "type": "object",
      "description": "Agent configuration — makes this skill an AI agent skill that runs an LLM loop instead of a single API call.",
      "required": ["intelligence", "system_prompt"],
      "properties": {
        "intelligence": {
          "type": "string",
          "description": "Intelligence reference: 'skill/model' (e.g., 'anthropic/claude-3-5-haiku-20241022')"
        },
        "system_prompt": {
          "type": "string",
          "description": "System prompt for the agent"
        },
        "tools": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Capabilities the agent can call. 'entity.operation' for runtime resolution, 'skill.entity.operation' for explicit binding."
        },
        "max_iterations": {
          "type": "integer",
          "description": "Maximum agent loop iterations (safety limit, default: 20)"
        },
        "temperature": {
          "type": "number",
          "description": "LLM sampling temperature (default: 0)"
        }
      },
      "additionalProperties": false
    },
    "credits": {
      "type": "array",
      "description": "Relationships to other skills or entity capabilities. Unifies attribution and dependency declaration — if you need it, you credit it.",
      "items": {
        "type": "object",
        "required": ["relationship"],
        "properties": {
          "skill": {
            "type": "string",
            "description": "Skill ID in the community repo (e.g., 'git', 'write-app')"
          },
          "entity": {
            "type": "string",
            "description": "Entity type for capability-based references (e.g., 'repository', 'webpage')"
          },
          "operations": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Operations on the entity this skill uses (e.g., ['write', 'read'])"
          },
          "relationship": {
            "type": "string",
            "enum": ["needs", "desires", "appreciates"],
            "description": "'needs' = required to function, 'desires' = optional but better, 'appreciates' = attribution / inspiration"
          },
          "reason": {
            "type": "string",
            "description": "Optional note explaining why (shown in credits UI)"
          }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "dependency": {
      "type": "object",
      "description": "System dependency requirement",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Dependency name (e.g., 'yt-dlp', 'ffmpeg')"
        },
        "install": {
          "type": "object",
          "description": "Platform-specific install commands",
          "properties": {
            "macos": { "type": "string", "description": "macOS install command" },
            "linux": { "type": "string", "description": "Linux install command" },
            "windows": { "type": "string", "description": "Windows install command" }
          }
        }
      }
    },
    "skillSources": {
      "type": "object",
      "description": "External sources for Content Security Policy",
      "properties": {
        "images": {
          "type": "array",
          "description": "Image sources (thumbnails, avatars) → CSP img-src",
          "items": { "type": "string" }
        },
        "api": {
          "type": "array",
          "description": "API endpoints → CSP connect-src",
          "items": { "type": "string" }
        },
        "scripts": {
          "type": "array",
          "description": "External scripts → CSP script-src (use sparingly)",
          "items": { "type": "string" }
        },
        "styles": {
          "type": "array",
          "description": "External stylesheets → CSP style-src",
          "items": { "type": "string" }
        },
        "fonts": {
          "type": "array",
          "description": "Web fonts → CSP font-src",
          "items": { "type": "string" }
        },
        "frames": {
          "type": "array",
          "description": "Embeddable frame sources (video players) → CSP frame-src",
          "items": { "type": "string" }
        },
        "image_headers": {
          "type": "object",
          "description": "Custom HTTP headers for the image proxy when fetching from this skill's image domains",
          "additionalProperties": { "type": "string" }
        }
      }
    },
    "transformer": {
      "type": "object",
      "description": "Entity transformer that transforms API data into universal entity format",
      "required": ["mapping"],
      "additionalProperties": false,
      "properties": {
        "terminology": {
          "type": "string",
          "description": "What this service calls this entity (e.g., 'Issue' for Linear's tasks)"
        },
        "mapping": {
          "type": "object",
          "description": "API response → entity property mappings. Defined once, applied to all operations returning this entity.",
          "additionalProperties": {
            "oneOf": [
              { "type": "string", "description": "jaq expression (e.g., '.id', '.content', '5 - .priority')" },
              { "type": "null", "description": "Not provided by this API" },
              {
                "type": "object",
                "description": "Relationship ref: looks up existing entity and creates a typed relationship. Value can evaluate to scalar or array (creates one relationship per element). Direction inferred from relationship schemas.",
                "required": ["ref", "value"],
                "properties": {
                  "ref": { "type": "string", "description": "Entity type to look up (e.g., 'journey', 'outcome')" },
                  "value": { "type": "string", "description": "jaq expression for the lookup value (scalar or array)" },
                  "rel": { "type": "string", "description": "Explicit relationship type (optional — inferred from schemas if unambiguous)" },
                  "lookup": { "type": "string", "enum": ["service_id", "name"], "description": "How to find the referenced entity: by service_id (default) or by name" }
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "description": "Typed reference: creates linked entity + relationship. The field name in the parent mapping IS the relationship type. Must have exactly one key (entity type) mapping to field definitions.",
                "minProperties": 1,
                "maxProperties": 1,
                "not": {
                  "required": ["_rel"]
                },
                "additionalProperties": {
                  "type": "object",
                  "description": "Entity field mappings — jaq expressions for entity properties (e.g., { id: '.channel_id', name: '.channel' })",
                  "additionalProperties": {
                    "type": "string",
                    "description": "jaq expression for entity field"
                  }
                }
              }
            ]
          }
        }
      }
    },
    "operation": {
      "type": "object",
      "description": "Entity operation that returns typed entities",
      "required": ["returns"],
      "properties": {
        "description": {
          "type": "string",
          "description": "Human-readable description of what this operation does"
        },
        "returns": {
          "type": "string",
          "description": "Return type: entity name, entity[], or void",
          "pattern": "^([a-z_]+(\\[\\])?|void)$"
        },
        "params": {
          "type": "object",
          "description": "Operation parameters",
          "additionalProperties": {
            "$ref": "#/definitions/paramDef"
          }
        },
        "rest": {
          "$ref": "#/definitions/restExecutor"
        },
        "graphql": {
          "$ref": "#/definitions/graphqlExecutor"
        },
        "sql": {
          "$ref": "#/definitions/sqlExecutor"
        },
        "command": {
          "$ref": "#/definitions/commandExecutor"
        },
        "swift": {
          "$ref": "#/definitions/swiftExecutor"
        },
        "csv": {
          "$ref": "#/definitions/csvExecutor"
        }
      }
    },
    "utility": {
      "type": "object",
      "description": "Helper operation that returns a custom shape, model reference, or entity",
      "required": ["returns"],
      "properties": {
        "description": {
          "type": "string",
          "description": "Human-readable description of what this utility does"
        },
        "params": {
          "type": "object",
          "description": "Utility parameters (inputs)",
          "additionalProperties": {
            "$ref": "#/definitions/paramDef"
          }
        },
        "returns": {
          "oneOf": [
            {
              "type": "string",
              "description": "Model/entity reference (e.g., 'dns_record', 'dns_record[]') or void",
              "pattern": "^([a-z_]+(\\[\\])?|void)$"
            },
              {
                "type": "object",
                "description": "Inline schema for skill-specific return shapes",
              "additionalProperties": {
                "oneOf": [
                  { "type": "string", "description": "Property type (string, boolean, integer, array, etc.)" },
                  {
                    "type": "object",
                    "description": "Detailed property definition",
                    "properties": {
                      "type": { "type": "string" },
                      "description": { "type": "string" }
                    }
                  }
                ]
              }
            }
          ]
        },
        "rest": {
          "$ref": "#/definitions/restExecutor"
        },
        "graphql": {
          "$ref": "#/definitions/graphqlExecutor"
        },
        "sql": {
          "$ref": "#/definitions/sqlExecutor"
        },
        "command": {
          "$ref": "#/definitions/commandExecutor"
        },
        "swift": {
          "$ref": "#/definitions/swiftExecutor"
        },
        "csv": {
          "$ref": "#/definitions/csvExecutor"
        }
      }
    },
    "auth": {
      "type": "object",
      "description": "Authentication configuration",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["api_key", "oauth", "cookies", "local_path", "connection_string", "keychain", "safestorage", "browser_session", "none"],
          "description": "Authentication type"
        },
        "domain": {
          "type": "string",
          "description": "Cookie domain (for cookies / browser_session auth)"
        },
        "cookies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required cookie names (for cookies auth)"
        },
        "header": {
          "type": "string",
          "description": "HTTP header name (e.g., Authorization)"
        },
        "prefix": {
          "type": "string",
          "description": "Value prefix (e.g., 'Bearer ')"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label for the credential input"
        },
        "placeholder": {
          "type": "string",
          "description": "Example value shown in input field"
        },
        "help_url": {
          "type": "string",
          "format": "uri",
          "description": "URL to documentation on how to get credentials"
        },
        "service": {
          "type": "string",
          "description": "macOS Keychain service name (for keychain auth)"
        },
        "account": {
          "type": "string",
          "description": "macOS Keychain account name; '$USER' expands to current user (for keychain auth)"
        },
        "app": {
          "type": "string",
          "description": "Electron app name for safeStorage key lookup, e.g. 'Claude' (for safestorage auth)"
        },
        "config": {
          "type": "string",
          "description": "Path to encrypted Electron config file; supports ~ (for safestorage auth)"
        },
        "key": {
          "type": "string",
          "description": "Top-level JSON key in the decrypted config, e.g. 'oauth:tokenCache' (for safestorage auth)"
        },
        "token_field": {
          "type": "string",
          "description": "Field name for the access token within the cache object (for safestorage auth)"
        },
        "refresh_field": {
          "type": "string",
          "description": "Field name for the refresh token (for safestorage auth)"
        },
        "expires_field": {
          "type": "string",
          "description": "Field name for the token expiry timestamp (unix ms) (for safestorage auth)"
        },
        "refresh_url": {
          "type": "string",
          "description": "URL to POST a refresh_token grant to (for safestorage auth)"
        },
        "refresh_client_id": {
          "type": "string",
          "description": "OAuth client_id for the refresh token request (for safestorage auth)"
        },
        "extra_headers": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Extra headers sent with token refresh requests (for safestorage auth)"
        },
        "browser": {
          "type": "string",
          "enum": ["firefox", "chrome", "brave", "arc", "edge", "auto"],
          "description": "Browser to read session cookies from (for browser_session auth)"
        },
        "cookie": {
          "type": "string",
          "description": "Cookie name to extract, e.g. 'sessionid' (for browser_session auth)"
        },
        "fallback": {
          "type": "string",
          "description": "Fallback auth type if browser session not found, e.g. 'cookies'"
        }
      }
    },
    "api": {
      "type": "object",
      "description": "API configuration",
      "properties": {
        "base_url": {
          "type": "string",
          "format": "uri",
          "description": "Base URL for REST endpoints"
        },
        "graphql": {
          "type": "string",
          "format": "uri",
          "description": "GraphQL endpoint URL"
        }
      }
    },
    "paramDef": {
      "type": "object",
      "description": "Parameter definition",
      "properties": {
        "type": {
          "type": "string",
          "description": "Parameter type"
        },
        "required": {
          "type": "boolean",
          "description": "Whether parameter is required"
        },
        "default": {
          "description": "Default value if not provided"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "example": {
          "description": "Example value"
        },
        "enum": {
          "type": "array",
          "description": "Allowed values"
        }
      }
    },
    "restExecutor": {
      "type": "object",
      "description": "REST API call",
      "required": ["url"],
      "properties": {
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE"],
          "default": "GET"
        },
        "url": {
          "type": "string",
          "description": "Request URL (jaq expression, e.g. '\"https://api.example.com/\" + .params.id')"
        },
        "headers": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "query": {
          "type": "object",
          "description": "Query string parameters",
          "additionalProperties": { "type": "string" }
        },
        "body": {
          "description": "Request body (for POST/PUT/PATCH)"
        },
        "encoding": {
          "type": "string",
          "enum": ["json", "form"],
          "description": "Body encoding (default: json)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "graphqlExecutor": {
      "type": "object",
      "description": "GraphQL query/mutation",
      "required": ["query"],
      "properties": {
        "endpoint": {
          "type": "string",
          "format": "uri",
          "description": "GraphQL endpoint (overrides api.graphql)"
        },
        "query": {
          "type": "string",
          "description": "GraphQL query or mutation"
        },
        "variables": {
          "type": "object",
          "description": "Query variables (values are jaq expressions)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "sqlExecutor": {
      "type": "object",
      "description": "SQL query",
      "required": ["query"],
      "properties": {
        "query": {
          "type": "string",
          "description": "SQL query (jaq expression)"
        },
        "database": {
          "type": "string",
          "description": "Database path (overrides skill-level)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "commandExecutor": {
      "type": "object",
      "description": "Shell command",
      "required": ["binary"],
      "properties": {
        "binary": {
          "type": "string",
          "description": "Binary to execute"
        },
        "args": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Arguments (jaq expressions)"
        },
        "args_string": {
          "type": "string",
          "description": "Arguments as single string (split on whitespace)"
        },
        "stdin": {
          "type": "string",
          "description": "Content to pass via stdin"
        },
        "timeout": {
          "type": "integer",
          "description": "Timeout in seconds (default: 60)"
        },
        "working_dir": {
          "type": "string",
          "description": "Working directory"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "swiftExecutor": {
      "type": "object",
      "description": "Swift script (macOS only)",
      "required": ["script"],
      "properties": {
        "script": {
          "type": "string",
          "description": "Swift code to execute"
        },
        "args": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Arguments to pass to compiled binary"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "csvExecutor": {
      "type": "object",
      "description": "CSV file reader",
      "required": ["path"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Path to CSV file (jaq expression, supports ~ expansion)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "seedEntity": {
      "type": "object",
      "description": "A seed entity declared by a skill for auto-creation",
      "required": ["id", "types", "name"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Well-known slug for cross-adapter dedup (e.g., 'youtube', 'google', 'meta')"
        },
        "types": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Entity types (e.g., ['product'], ['organization'])"
        },
        "name": {
          "type": "string",
          "description": "Display name"
        },
        "data": {
          "type": "object",
          "description": "Entity properties matching the entity schema"
        },
        "relationships": {
          "type": "array",
          "description": "Relationships from this entity to other seed entities",
          "items": {
            "type": "object",
            "required": ["role", "to"],
            "properties": {
              "role": {
                "type": "string",
                "description": "Reference role (e.g., 'offered_by', 'parent_of')"
              },
              "to": {
                "type": "string",
                "description": "Target seed entity ID"
              },
              "data": {
                "type": "object",
                "description": "Optional relationship data"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "responseMapping": {
      "type": "object",
      "description": "Response transformation",
      "properties": {
        "root": {
          "type": "string",
          "description": "JSON Pointer (RFC 6901) to extract data. Must start with '/'. For entity[] operations, root must point to the array (e.g. '/results', '/data/items'). Use '/' for APIs that return a top-level array. The final activity.response is always a top-level array for list/search.",
          "pattern": "^/.*$"
        },
        "context": {
          "type": "object",
          "description": "Capture values from response for use in mapping (e.g., viewer_id: thread.viewer_id)",
          "additionalProperties": {
            "type": "string"
          }
        },
        "mapping": {
          "type": "object",
          "description": "Field mappings for utilities (operations use transformers.{entity}.mapping instead)",
          "additionalProperties": true
        },
        "static": {
          "type": "object",
          "description": "Static response for operations that don't return data (e.g., complete returns { id, completed: true })",
          "additionalProperties": true
        }
      }
    }
  }
}
