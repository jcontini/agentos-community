{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentos.dev/schemas/plugin.schema.json",
  "title": "AgentOS Plugin",
  "description": "Schema for AgentOS plugin readme.md frontmatter",
  "type": "object",
  "required": ["id", "name", "description", "tags"],
  "anyOf": [
    { "required": ["entities"] },
    { "required": ["actions"] }
  ],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier (lowercase, hyphenated)",
      "pattern": "^[a-z][a-z0-9-]*$"
    },
    "name": {
      "type": "string",
      "description": "Display name"
    },
    "description": {
      "type": "string",
      "description": "One-line description of what this plugin does"
    },
    "icon": {
      "type": "string",
      "description": "Icon filename (icon.svg or icon.png)",
      "default": "icon.png"
    },
    "website": {
      "type": "string",
      "format": "uri",
      "description": "URL to the service's website"
    },
    "tags": {
      "type": "array",
      "description": "Domain tags for discoverability (e.g., [tasks, issues])",
      "items": {
        "type": "string"
      },
      "minItems": 1
    },
    "auth": {
      "oneOf": [
        { "type": "null", "description": "No authentication required" },
        { "$ref": "#/definitions/auth" }
      ]
    },
    "api": {
      "$ref": "#/definitions/api"
    },
    "database": {
      "oneOf": [
        { "type": "string", "description": "Path to SQLite database (supports ~ and globs)" },
        {
          "type": "object",
          "description": "Platform-specific database paths",
          "properties": {
            "macos": { "type": "string" },
            "windows": { "type": "string" },
            "linux": { "type": "string" }
          }
        }
      ]
    },
    "terminology": {
      "type": "object",
      "description": "Maps entity IDs to service-specific display names (e.g., task â†’ Issue for Linear)",
      "additionalProperties": {
        "type": "string"
      }
    },
    "relationships": {
      "type": "object",
      "description": "Relationship support declarations (keyed by relationship ID from graph.yaml)",
      "additionalProperties": {
        "$ref": "#/definitions/relationshipSupport"
      }
    },
    "entities": {
      "type": "object",
      "description": "Entity-based operations (e.g., entities.webpage.search)",
      "additionalProperties": {
        "type": "object",
        "description": "Operations for this entity",
        "additionalProperties": {
          "$ref": "#/definitions/singleAction"
        }
      }
    },
    "actions": {
      "type": "object",
      "description": "Action implementations (legacy format, use entities instead)",
      "additionalProperties": {
        "$ref": "#/definitions/action"
      }
    }
  },
  "definitions": {
    "auth": {
      "type": "object",
      "description": "Authentication configuration",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["api_key", "oauth", "cookies", "local_path", "connection_string", "none"],
          "description": "Authentication type"
        },
        "domain": {
          "type": "string",
          "description": "Cookie domain (for cookies auth)"
        },
        "cookies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required cookie names (for cookies auth)"
        },
        "header": {
          "type": "string",
          "description": "HTTP header name (e.g., Authorization)"
        },
        "prefix": {
          "type": "string",
          "description": "Value prefix (e.g., 'Bearer ')"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label for the credential input"
        },
        "placeholder": {
          "type": "string",
          "description": "Example value shown in input field"
        },
        "help_url": {
          "type": "string",
          "format": "uri",
          "description": "URL to documentation on how to get credentials"
        }
      }
    },
    "api": {
      "type": "object",
      "description": "API configuration",
      "properties": {
        "base_url": {
          "type": "string",
          "format": "uri",
          "description": "Base URL for REST endpoints"
        },
        "graphql": {
          "type": "string",
          "format": "uri",
          "description": "GraphQL endpoint URL"
        }
      }
    },
    "action": {
      "oneOf": [
        { "$ref": "#/definitions/singleAction" },
        {
          "type": "array",
          "description": "Chained actions (executed in sequence)",
          "items": { "$ref": "#/definitions/singleAction" }
        }
      ]
    },
    "singleAction": {
      "type": "object",
      "description": "Single action implementation",
      "properties": {
        "operation": {
          "type": "string",
          "description": "(DEPRECATED - implicit from structure) CRUD operation type",
          "enum": ["read", "create", "update", "delete"]
        },
        "provides": {
          "type": "string",
          "description": "(DEPRECATED - implicit from structure) Capability this action provides"
        },
        "label": {
          "type": "string",
          "description": "Human-readable action label"
        },
        "params": {
          "type": "object",
          "description": "Action parameters",
          "additionalProperties": {
            "$ref": "#/definitions/paramDef"
          }
        },
        "as": {
          "type": "string",
          "description": "Variable name for storing result in chained actions"
        },
        "rest": {
          "$ref": "#/definitions/restExecutor"
        },
        "graphql": {
          "$ref": "#/definitions/graphqlExecutor"
        },
        "sql": {
          "$ref": "#/definitions/sqlExecutor"
        },
        "command": {
          "$ref": "#/definitions/commandExecutor"
        },
        "swift": {
          "$ref": "#/definitions/swiftExecutor"
        }
      }
    },
    "paramDef": {
      "type": "object",
      "description": "Parameter definition",
      "properties": {
        "type": {
          "type": "string",
          "description": "Parameter type"
        },
        "required": {
          "type": "boolean",
          "description": "Whether parameter is required"
        },
        "default": {
          "description": "Default value if not provided"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "example": {
          "description": "Example value"
        },
        "enum": {
          "type": "array",
          "description": "Allowed values"
        }
      }
    },
    "restExecutor": {
      "type": "object",
      "description": "REST API call",
      "required": ["url"],
      "properties": {
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE"],
          "default": "GET"
        },
        "url": {
          "type": "string",
          "description": "Request URL (supports {{params.x}} templates)"
        },
        "headers": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "body": {
          "description": "Request body (for POST/PUT/PATCH)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "graphqlExecutor": {
      "type": "object",
      "description": "GraphQL query/mutation",
      "required": ["query"],
      "properties": {
        "endpoint": {
          "type": "string",
          "format": "uri",
          "description": "GraphQL endpoint (overrides api.graphql)"
        },
        "query": {
          "type": "string",
          "description": "GraphQL query or mutation"
        },
        "variables": {
          "type": "object",
          "description": "Query variables (supports {{params.x}} templates)"
        },
        "response": {
          "$ref": "#/definitions/responseMapping"
        }
      }
    },
    "sqlExecutor": {
      "type": "object",
      "description": "SQL query",
      "required": ["query"],
      "properties": {
        "query": {
          "type": "string",
          "description": "SQL query (supports {{params.x}} templates)"
        },
        "database": {
          "type": "string",
          "description": "Database path (overrides plugin-level)"
        }
      }
    },
    "commandExecutor": {
      "type": "object",
      "description": "Shell command",
      "properties": {
        "run": {
          "type": "string",
          "description": "Command to execute (supports {{params.x}} templates)"
        },
        "binary": {
          "type": "string",
          "description": "Binary to execute"
        },
        "args": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Arguments (supports {{params.x}} templates)"
        }
      }
    },
    "swiftExecutor": {
      "type": "object",
      "description": "Swift script (macOS only)",
      "required": ["script"],
      "properties": {
        "script": {
          "type": "string",
          "description": "Swift code to execute"
        }
      }
    },
    "responseMapping": {
      "type": "object",
      "description": "Response transformation",
      "properties": {
        "root": {
          "type": "string",
          "description": "JSONPath to extract (e.g., 'data.items')"
        },
        "mapping": {
          "type": "object",
          "description": "Field mappings (target: jmespath or nested object)",
          "additionalProperties": true
        }
      }
    },
    "relationshipSupport": {
      "type": "object",
      "description": "How this plugin supports a relationship",
      "required": ["support"],
      "properties": {
        "support": {
          "type": "string",
          "enum": ["full", "read_only", "write_only", "none"],
          "description": "Level of support: full (read+write), read_only, write_only, none"
        },
        "field": {
          "type": "string",
          "description": "API response field that contains the relationship data (e.g., 'project_id')"
        }
      }
    }
  }
}
