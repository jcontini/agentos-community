# Pre-commit: Fast structural validation (~1s), scoped to staged files only
#
# Checks (blocking):
# - Schema validation ‚Äî is the YAML structurally valid?
# - Security checks ‚Äî no credential exposure patterns
#
# NOT checked here (belong in `npm run validate` / CI / pre-push):
# - Test coverage (are all operations tested?)
# - Test linting (do test files follow patterns?)
# - Entity references (do operations return known entities?)
# - Pattern validation (typed references, best practices)

STAGED_READMES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^skills/[^/]+/readme\.md$' || true)

# Nothing to check
if [ -z "$STAGED_READMES" ]; then
  exit 0
fi

ERRORS=0
APPS=$(echo "$STAGED_READMES" | sed 's|skills/||' | sed 's|/readme.md||' | tr '\n' ' ')

# === Schema Validation ===
echo "üìã Schema validation..."
node tests/skills/scripts/validate.mjs $APPS --no-move --no-coverage --no-refs || ERRORS=$((ERRORS + 1))
echo ""

# === Security Checks ===
echo "üîí Security checks..."

if echo "$STAGED_READMES" | xargs grep -l '\$AUTH_TOKEN\|\${AUTH_TOKEN}' 2>/dev/null; then
  echo "‚ùå BLOCKED: \$AUTH_TOKEN found - use rest: or graphql: blocks instead"
  ERRORS=$((ERRORS + 1))
fi

if echo "$STAGED_READMES" | xargs grep -l 'curl.*[Aa]uthorization\|wget' 2>/dev/null; then
  echo "‚ùå BLOCKED: curl/wget with auth - use AgentOS executors (rest:, graphql:, sql:)"
  ERRORS=$((ERRORS + 1))
fi

if echo "$STAGED_READMES" | xargs grep -l 'Bearer \$' 2>/dev/null; then
  echo "‚ùå BLOCKED: Bearer token interpolation - AgentOS handles auth automatically"
  ERRORS=$((ERRORS + 1))
fi
echo ""

if [ $ERRORS -eq 0 ]; then
  echo "‚úÖ All checks passed"
else
  echo "‚ùå Fix $ERRORS error(s) before committing"
  exit 1
fi
